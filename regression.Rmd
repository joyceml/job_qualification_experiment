---
title: "Conjoint Experiment Regression"
author: Amy Jung, Joyce Li, Meer Wu
output:
  pdf_document: default
  word_document: default
date: '2022-04-08'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::knit_engines$set(problem_description = function(options) {
  code <- paste(options$code, collapse = "\n")
})
```


```{r load packages, message = FALSE}
library(data.table)

library(sandwich)
library(lmtest)

library(AER) 

library(ggplot2) 
library(patchwork)

library(stargazer)
library(cregg)
```

## Load Data

```{r pressure, echo=FALSE}
d = fread('~/job_qualification_experiment_w241/final_dataset.csv')
d[, male := ifelse(gender=='Male', 1, 0)]
d[, top50 := ifelse(college_binary=='1-50', 1, 0)]
d[, front_facing_role := ifelse(job_binary=='front-facing', 1, 0)]
d
```

## Regression

### Basic Model

```{r basic model, echo=TRUE}
# model with only beauty filter indicator, the feature we are most interested in investigating
basic_mod = lm(Y ~ filtered, data=d)

basic_mod$cluster_se <- sqrt(diag(vcovCL(basic_mod, cluster = d[, id])))

stargazer(
  basic_mod, 
  se = list(basic_mod$cluster_se), 
  type = 'text'
)
```

### Full Conjoint Model

```{r full model, echo=TRUE}
# model with all the features varied in the conjoint experiment
# features: beatuy filter, sex, ethnicity, years of experience, job role, college prestige
full_mod = lm(Y ~ filtered + male + ethnicity + as.factor(exp) + front_facing_role + top50,
              data=d)

full_mod$cluster_se <- sqrt(diag(vcovCL(full_mod, cluster = d[, id])))

stargazer(
  full_mod, 
  se = list(full_mod$cluster_se), 
  type = 'text'
)
```

### Full Model with Covariates

```{r full model with covariates, echo=TRUE}
# model with covariates (respondent demographics)
mod_with_covariates = lm(Y ~ filtered + male + ethnicity + as.factor(exp) + front_facing_role + top50 +
                             resp_sex + resp_ethnicity + resp_age + resp_education, data=d)

mod_with_covariates$cluster_se <- sqrt(diag(vcovCL(mod_with_covariates, cluster = d[, id])))

stargazer(
  basic_mod,
  full_mod,
  mod_with_covariates, 
  se = list(mod_with_covariates$cluster_se), 
  type = 'text'
)
```


```{r}
library(cjoint)
#amce model with all effects
amce_mod <- amce(Y ~ filtered + male + ethnicity + exp + front_facing_role + top50 + resp_sex + resp_ethnicity + resp_age + resp_education, data=d,
                cluster=TRUE, respondent.id="id")
```

```{r}
summary(amce_mod)
```
```{r}
#amce model with everything including covariates
amce_mod_full <- amce(Y ~ filtered + male + ethnicity + exp + front_facing_role + top50 + resp_sex + resp_ethnicity + resp_age + resp_education, data=d,
                cluster=TRUE, respondent.id="id")

summary(amce_mod_full)
```


```{r}
d$filtered_factor <- factor(d$filtered, levels=c("TRUE","FALSE"))
d$gender_factor <- factor(d$gender, levels=c("Male","Female"))
d$ethnicity_factor <- factor(d$ethnicity, levels=c("White","POC"))
d$exp_factor <- factor(d$exp, levels=c("5","6","7"))
d$job_binary_factor <- factor(d$job_binary, levels=c("front-facing","back-facing"))
d$college_binary_factor <- factor(d$college_binary, levels=c("1-50", "50-100"))
# to factor: resp_sex + resp_ethnicity + resp_age + resp_education
d
```


```{r}
amces <- cj(d, Y ~ filtered_factor + gender_factor + ethnicity_factor + exp_factor + job_binary_factor + college_binary_factor, id = ~id)
head(amces[c("feature", "level", "estimate", "std.error")], 20L)

```

